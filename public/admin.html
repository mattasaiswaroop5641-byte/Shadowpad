<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowPad Admin</title>
    <link rel="stylesheet" href="src/css/main.css">
    <style>
        body { overflow: auto; padding: 2rem; background-color: #0f172a; color: #fff; }
        .admin-container { max-width: 1000px; margin: 0 auto; }
        
        h1 { margin-bottom: 0.5rem; color: #818cf8; }
        p { color: #94a3b8; margin-bottom: 2rem; }

        table { width: 100%; border-collapse: collapse; background: rgba(30, 41, 59, 0.5); border-radius: 8px; overflow: hidden; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(30, 41, 59, 0.8); color: #818cf8; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; }
        tr:hover { background: rgba(255,255,255,0.02); }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; background: #334155; color: #cbd5e1; font-family: monospace; }
        
        .btn-danger { 
            background: rgba(239, 68, 68, 0.1); 
            color: #ef4444; 
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }

        .empty-state { text-align: center; padding: 3rem; color: #64748b; font-style: italic; }

        /* Login Styles */
        .login-container { max-width: 400px; margin: 100px auto; text-align: center; background: rgba(30, 41, 59, 0.5); padding: 2rem; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 1rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: white; border-radius: 8px; outline: none; }
        .login-input:focus { border-color: #818cf8; }
        .btn-primary { background: #6366f1; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: background 0.2s; }
        .btn-primary:hover { background: #818cf8; }
        #dashboard-view { display: none; }
        .error-msg { color: #ef4444; margin-top: 1rem; font-size: 0.9rem; display: none; }

        /* Stats Bar */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: rgba(15, 23, 42, 0.6); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .stat-label { color: #94a3b8; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; display: block; }
        .stat-value { font-size: 2rem; font-weight: 800; color: white; }
        .stat-value.green { color: #34d399; }
        .stat-value.blue { color: #60a5fa; }
        .stat-value.orange { color: #fbbf24; }
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="login-view" class="login-container">
        <h1>üîê Admin Login</h1>
        <p>Enter admin secret to continue</p>
        <form id="login-form">
            <input type="password" id="admin-secret" class="login-input" placeholder="Admin Secret" required>
            <button type="submit" class="btn-primary">Access Dashboard</button>
            <p id="login-error" class="error-msg"></p>
        </form>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard-view" class="admin-container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>üõ°Ô∏è ShadowPad Admin</h1>
            <button id="cleanup-btn" class="btn-danger" style="background: rgba(234, 179, 8, 0.1); color: #facc15; border-color: rgba(234, 179, 8, 0.2); margin-right: 10px;">üßπ Clean Old Data</button>
            <button id="logout-btn" class="btn-danger">Logout</button>
        </div>
        
        <!-- Stats Dashboard -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-label">Total Pads</span>
                <span id="total-pads" class="stat-value blue">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Total Storage</span>
                <span id="total-size" class="stat-value orange">0 MB</span>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Room ID</th>
                    <th>Last Active</th>
                    <th>Encrypted Size</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="pad-list">
                <!-- Rows injected here -->
            </tbody>
        </table>
    </div>

    <!-- Active Users View -->
    <div id="active-view" class="admin-container" style="display:none; margin-top: 2rem;">
        <h2>üü¢ Active Users (Real-time)</h2>
        <table>
            <thead>
                <tr>
                    <th>Room</th>
                    <th>User</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="active-list"></tbody>
        </table>
    </div>

    <script>
        let currentSecret = '';

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const secret = document.getElementById('admin-secret').value;
            const errorMsg = document.getElementById('login-error');
            
            try {
                await loadPads(secret);
                // If successful:
                currentSecret = secret;
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('dashboard-view').style.display = 'block';
                document.getElementById('active-view').style.display = 'block';
                loadActiveUsers(secret);
            } catch (err) {
                errorMsg.textContent = "Access Denied: Incorrect Secret";
                errorMsg.style.display = 'block';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            currentSecret = '';
            document.getElementById('admin-secret').value = '';
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('login-view').style.display = 'block';
            document.getElementById('active-view').style.display = 'none';
        });

        document.getElementById('cleanup-btn').addEventListener('click', async () => {
            const days = prompt("Delete pads inactive for how many days?", "30");
            if (!days) return;
            
            const res = await fetch('/api/cleanup-pads', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ secret: currentSecret, days: parseInt(days) })
            });
            const data = await res.json();
            alert(data.message || data.error);
            loadPads();
        });

        async function loadPads(secret = currentSecret) {
            const tbody = document.getElementById('pad-list');
            try {
                const res = await fetch(`/api/pads?secret=${encodeURIComponent(secret)}`);
                if (!res.ok) {
                    // Attempt to read error message from server
                    const errText = await res.text(); 
                    throw new Error(`Status ${res.status}: ${errText}`);
                }
                const pads = await res.json();

                if (pads.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No pads found in database.</td></tr>';
                    return;
                }

                // Update Stats
                document.getElementById('total-pads').textContent = pads.length;
                const totalBytes = pads.reduce((acc, pad) => acc + (pad.size || 0), 0);
                const totalMB = (totalBytes / (1024 * 1024)).toFixed(2);
                document.getElementById('total-size').textContent = `${totalMB} MB`;

                tbody.innerHTML = pads.map(pad => `
                    <tr>
                        <td><span class="badge">${pad.roomId}</span></td>
                        <td>${new Date(pad.lastActive).toLocaleString()}</td>
                        <td>${pad.size} chars</td>
                        <td>
                            <button class="btn-danger" onclick="deletePad('${pad.roomId.replace(/'/g, "\\'")}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4" class="empty-state" style="color:#ef4444">Error: ${e.message}</td></tr>`;
            }
        }

        async function deletePad(roomId) {
            if(!confirm(`Are you sure you want to delete the pad "${roomId}"? This cannot be undone.`)) return;
            
            await fetch('/api/delete-pad', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ roomId, secret: currentSecret })
            });
            loadPads(); // Refresh list
        }

        async function loadActiveUsers(secret = currentSecret) {
            const tbody = document.getElementById('active-list');
            try {
                const res = await fetch(`/api/active-rooms?secret=${encodeURIComponent(secret)}`);
                if (!res.ok) throw new Error('Failed to fetch active users');
                const rooms = await res.json();

                if (rooms.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No active users online.</td></tr>';
                    return;
                }

                let html = '';
                rooms.forEach(room => {
                    room.users.forEach(user => {
                        html += `
                            <tr>
                                <td><span class="badge">${room.roomId}</span></td>
                                <td>${user.name} ${user.isHost ? 'üëë' : ''} <span style="font-size:0.8em; opacity:0.5">(${user.id})</span></td>
                                <td><button class="btn-danger" onclick="kickUser('${user.id}')">Kick</button></td>
                            </tr>
                        `;
                    });
                });
                tbody.innerHTML = html;
            } catch (e) {
                console.error(e);
            }
        }

        async function kickUser(socketId) {
            if(!confirm("Kick this user?")) return;
            await fetch('/api/kick-user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ socketId, secret: currentSecret })
            });
            setTimeout(loadActiveUsers, 500); // Refresh list
        }
    </script>
</body>
</html>